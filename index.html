<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Sklad Dashboard Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0d0e12; --card: #1a1c23; --text: #fff; --dim: #8b9bb4; --green: #00ff9d; --yellow: #ffcc00; --red: #ff4757; --blue: #2d98da; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: grid; grid-template-rows: 80px 1fr; padding: 20px; box-sizing: border-box; }
        
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #2c303a; padding-bottom: 10px; margin-bottom: 20px; }
        .header-title { font-size: 32px; font-weight: 900; letter-spacing: 2px; color: var(--dim); }
        .clock { font-family: 'JetBrains Mono', monospace; font-size: 48px; font-weight: 700; }
        .date { font-size: 20px; color: var(--dim); text-align: right; }

        .grid { display: grid; grid-template-columns: 1fr 1.2fr; grid-template-rows: 1fr 1.5fr; gap: 20px; height: 100%; }
        .card { background: var(--card); border-radius: 20px; padding: 30px; border: 1px solid #333; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ */
        .status-panel { grid-row: 1 / 3; align-items: center; justify-content: center; text-align: center; }
        .circle-wrap { width: 320px; height: 320px; position: relative; margin-bottom: 40px; }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 25; stroke-linecap: round; }
        .bg-c { stroke: #2c303a; }
        .fg-c { stroke: var(--green); transition: stroke-dashoffset 1.5s ease; filter: drop-shadow(0 0 15px rgba(0,255,157,0.4)); }
        .pct { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; font-weight: 900; }
        .count { font-size: 36px; color: var(--dim); margin-bottom: 30px; }
        .badge { padding: 15px 40px; border-radius: 50px; font-size: 40px; font-weight: 700; border: 2px solid #444; }

        /* –ü–†–ê–í–ê–Ø –í–ï–†–•–ù–Ø–Ø */
        .next-panel { grid-column: 2; justify-content: center; }
        .label { color: var(--dim); font-size: 20px; text-transform: uppercase; margin-bottom: 10px; }
        .nid { font-size: 55px; font-weight: 900; font-family: 'JetBrains Mono'; margin-bottom: 10px; }
        .ninfo { font-size: 28px; }
        .warn { color: var(--red); animation: pulse 2s infinite; }
        .arr { color: var(--blue); }

        /* –ü–†–ê–í–ê–Ø –ù–ò–ñ–ù–Ø–Ø */
        .list-panel { grid-column: 2; background: #15171d; }
        .list-mask { flex: 1; overflow: hidden; position: relative; }
        .list-content { position: absolute; width: 100%; }
        .item { font-family: 'JetBrains Mono'; font-size: 24px; padding: 20px 0; border-bottom: 1px solid #333; color: #ddd; display: flex; align-items: center; }
        .item span { margin-right: 15px; }

        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes scrollUp { 0% { transform: translateY(0); } 15% { transform: translateY(0); } 100% { transform: translateY(-100%); } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">–°–ö–õ–ê–î LIVE</div>
        <div>
            <div class="clock" id="clock">00:00</div>
            <div class="date" id="date">-- ---</div>
        </div>
    </div>

    <div class="grid">
        <div class="card status-panel">
            <div class="circle-wrap">
                <svg viewBox="0 0 350 350"><circle cx="175" cy="175" r="150" class="bg-c"/><circle cx="175" cy="175" r="150" class="fg-c" id="ring" stroke-dasharray="942" stroke-dashoffset="942"/></svg>
                <div class="pct" id="pct">0%</div>
            </div>
            <div class="count" id="cnt">-- / --</div>
            <div class="badge" id="sts">–ó–ê–ì–†–£–ó–ö–ê</div>
        </div>

        <div class="card next-panel">
            <div class="label">–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä</div>
            <div class="nid" id="nid">‚Äî</div>
            <div class="ninfo" id="ninfo">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        </div>

        <div class="card list-panel">
            <div class="label" style="color: var(--green);">üöö –ê–ö–¢–ò–í–ù–´–ï –†–ê–ó–ì–†–£–ó–ö–ò</div>
            <div class="list-mask" id="mask">
                <div class="list-content" id="list"></div>
            </div>
        </div>
    </div>

    <script>
        // –í–ê–®–ê –°–°–´–õ–ö–ê
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS0kYp4Zp2m9jmTRMTZoamaEUBfZg95n3YN_7f0YByCva_978_452f538CXgKhzveg-etToheOTaVCJ/pub?gid=1966680390&single=true&output=csv'; 

        setInterval(() => {
            const d = new Date();
            document.getElementById('clock').innerText = d.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('date').innerText = d.toLocaleDateString('ru-RU', {weekday:'long', day:'numeric', month:'long'});
        }, 1000);

        async function update() {
            try {
                const res = await fetch(csvUrl + '&t=' + Date.now());
                const txt = await res.text();
                
                // –ê–≤—Ç–æ-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
                const firstLine = txt.split('\n')[0];
                const separator = firstLine.includes(';') ? ';' : ',';

                const rows = txt.split('\n').map(r => r.split(separator)); 

                // 1. –°–¢–†–û–ö–ê 1 (–ì–õ–ê–í–ù–´–ï –î–ê–ù–ù–´–ï)
                const r1 = rows[0]; 
                if (r1 && r1.length > 2) {
                    const st = r1[0].replace(/"/g,'').trim();
                    const badge = document.getElementById('sts');
                    
                    if (st === "ACTIVE") {
                        badge.innerText = "üü¢ –í –†–ê–ë–û–¢–ï";
                        badge.style.color = "#00ff9d"; badge.style.borderColor = "#00ff9d";
                    } else if (st === "PAUSE") {
                        badge.innerText = "‚è∏ –ü–ê–£–ó–ê";
                        badge.style.color = "#aaa"; badge.style.borderColor = "#555";
                    } else {
                        badge.innerText = "üü° –û–ñ–ò–î–ê–ù–ò–ï";
                        badge.style.color = "#ffcc00"; badge.style.borderColor = "#ffcc00";
                    }

                    const counts = r1[1].replace(/"/g,'').split('|');
                    const done = parseInt(counts[0]) || 0;
                    const total = parseInt(counts[1]) || 0;
                    
                    document.getElementById('cnt').innerText = `${done} –∏–∑ ${total}`;
                    const p = total > 0 ? Math.round((done/total)*100) : 0;
                    document.getElementById('pct').innerText = p + '%';
                    document.getElementById('ring').style.strokeDashoffset = 942 - (942 * p / 100);

                    document.getElementById('nid').innerText = r1[2].replace(/"/g,'').trim();
                    const ninf = r1[3] ? r1[3].replace(/"/g,'').trim() : "";
                    const idiv = document.getElementById('ninfo');
                    
                    if (ninf.includes("–û–ü–û–ó–î–ê–ù–ò–ï")) idiv.innerHTML = `<span class="warn">${ninf}</span>`;
                    else idiv.innerHTML = `<span class="arr">${ninf}</span>`;
                }

                // 2. –°–ü–ò–°–û–ö (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ß–ê–°–¢–¨)
                const listEl = document.getElementById('list');
                const rawLines = txt.split('\n');
                listEl.innerHTML = '';
                
                let foundAny = false;
                for (let i = 1; i < rawLines.length; i++) {
                    let line = rawLines[i].replace(/^"|"$/g, '');
                    line = line.replace(/^[;,]+/, '');

                    if (line.includes('|')) {
                        let parts = line.split('|');
                        if (parts.length >= 3) {
                            foundAny = true;
                            let id = parts[0].trim();
                            let time = parts[1].trim();
                            
                            // !!! –ó–î–ï–°–¨ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ü–Ø–¢–´–• !!!
                            // –ú—ã –±–µ—Ä–µ–º —Ç–µ–∫—Å—Ç, –∏ —Å –ø–æ–º–æ—â—å—é parseInt –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞–µ–º –∏–∑ –Ω–µ–≥–æ —á–∏—Å–ª–æ
                            // "-416,,," –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –≤ "-416"
                            let durRaw = parts[2].replace(/[,;"]/g, '').trim(); 
                            let dur = parseInt(durRaw); 

                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Ç–∞–º –Ω–µ —á–∏—Å–ª–æ
                            if (isNaN(dur)) dur = durRaw; 
                            
                            let div = document.createElement('div');
                            div.className = 'item';
                            div.innerHTML = `<span>üì¶ ${id}</span> <span>‚è± ${time}</span> <span>üïê ${dur} –º–∏–Ω.</span>`;
                            listEl.appendChild(div);
                        }
                    }
                }

                if (!foundAny) {
                    listEl.innerHTML = '<div class="item" style="color:#666; justify-content:center;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–∑–≥—Ä—É–∑–æ–∫</div>';
                    listEl.style.animation = 'none';
                } else {
                    const mh = document.getElementById('mask').clientHeight;
                    const ch = listEl.clientHeight;
                    if (ch > mh) {
                        listEl.style.animation = `scrollUp ${ch/5}s linear infinite`;
                        listEl.innerHTML += listEl.innerHTML; 
                    } else {
                        listEl.style.animation = 'none';
                    }
                }

            } catch(e) { console.log(e); }
        }

        setInterval(update, 5000);
        update();
    </script>
</body>
</html>